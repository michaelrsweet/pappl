#
# Test suite makefile for the Printer Application Framework
#
# Copyright Â© 2020 by Michael R Sweet
#
# Licensed under Apache License v2.0.  See the file "LICENSE" for more
# information.
#

include ../Makedefs


OBJS	=	\
		pwg-driver.o \
		hp-printer-app.o \
		testmainloop.o \
		testpappl.o

TARGETS	=	\
		testmainloop \
		testpappl
#		hp-printer-app \


HAVE_SYSTEMD := $(shell pkg-config --exists systemd 2>/dev/null && echo 'yes')

ifeq ($(HAVE_SYSTEMD),yes)
	unitdir := $(shell pkg-config --variable=systemdsystemunitdir systemd)
endif

# Make everything
all:		$(TARGETS)


# Clean everything
clean:
	$(RM) -r $(OBJS) $(TARGETS)


# Clean all non-distribution files
distclean:	clean


# Update dependencies
depend:
	$(CC) -MM $(CFLAGS) $(OBJS:.o=.c) | sed -e '1,$$s/ \/usr\/include\/[^ ]*//g'  -e '1,$$s/ \/usr\/local\/include\/[^ ]*//g' >Dependencies


# Install everything
install:	hp-printer-app
	echo Installing hp printer application in $(BUILDROOT)$(bindir)...
	$(INSTALL) -d -m 755 $(BUILDROOT)$(bindir)
	$(INSTALL) -c -m 755 hp-printer-app $(BUILDROOT)$(bindir)
ifeq ($(HAVE_SYSTEMD),yes)
	echo Installing hp-printer-app.service in $(unitdir)...
	$(INSTALL) -d -m 755 $(unitdir)
	$(INSTALL) -c -m 755 hp-printer-app.service $(unitdir)
endif


# Test everything
test:


# HP printer app
hp-printer-app:		hp-printer-app.o ../pappl/libpappl.a
	echo Linking $@...
	$(CC) $(LDFLAGS) -o $@ hp-printer-app.o ../pappl/libpappl.a $(LIBS)


# Test suite program
testpappl:	testpappl.o pwg-driver.o ../pappl/libpappl.a
	echo Linking $@...
	$(CC) $(LDFLAGS) -o $@ testpappl.o pwg-driver.o ../pappl/libpappl.a $(LIBS)
	$(CODE_SIGN) -s "$(CODESIGN_IDENTITY)" -o runtime --timestamp -i org.msweet.pappl.testpappl $@


# Mainloop test program
testmainloop:	testmainloop.o pwg-driver.o ../pappl/libpappl.a
	echo Linking $@...
	$(CC) $(LDFLAGS) -o $@ testmainloop.o pwg-driver.o ../pappl/libpappl.a $(LIBS)
	$(CODE_SIGN) -s "$(CODESIGN_IDENTITY)" -o runtime --timestamp -i org.msweet.pappl.testmainloop $@


# Static resource header...
resheader:
	echo Generating $@...
	../pappl/makeresource.sh label-*.png >label-png.h


# Dependencies
include Dependencies
